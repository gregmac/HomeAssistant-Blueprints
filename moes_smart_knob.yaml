blueprint:
  name: "Moes Smart Knob"
  domain: automation
  description: >
    
  author: gregmac
  source_url: https://github.com/gregmac/HomeAssistant-Blueprints/blob/main/moes_smart_knob.yaml

  input:
    #! knob:
    #!   name: Control knob
    #!   description: The knob to be configured
    #!   selector:
    #!     device:
    #!       manufacturer: TuYa
    #!       model: Smart knob (ERS-10TZBVK-AA)
    #!       multiple: false

    mqtt_topic:
      name: Knob
      description: >-
        MQTT topic name of the knob, as connected via zigbee2mqtt
      default: mqtt/knob_name
      selector:
        text:

    light:
      name: Light to control
      default: []
      description: >-
        If specified, directly controls a specific light.
        * Press knob to toggle on/off
        * Rotate for brightness
        * Hold to switch between color temperature and RGB mode
        * Hold and rotate to adjust color temperature or hue
      selector:
        entity: 
          domain: light

    step_size:
      name: Step size
      description: Percentage to adjust light for each rotate step
      selector:
        number:
          min: 1
          max: 100
          step: 1
      default: 10

    command_brightness_step_down:         { default: [], selector: { action: {} }, name: 'Custom Action: Rotate Left (Command mode)' }
    command_brightness_step_up:           { default: [], selector: { action: {} }, name: 'Custom Action: Rotate Right (Command mode)' }
    command_color_temperature_step_down:  { default: [], selector: { action: {} }, name: 'Custom Action: Hold + Rotate Left (Command mode)' }
    command_color_temperature_step_up:    { default: [], selector: { action: {} }, name: 'Custom Action: Hold + Rotate Right (Command mode)' }
    command_toggle:                       { default: [], selector: { action: {} }, name: 'Custom Action: Single press (Command mode)' }
    command_hue_move:                     { default: [], selector: { action: {} }, name: 'Custom Action: Hold for 3 seconds (Command mode)' }
    command_hue_stop:                     { default: [], selector: { action: {} }, name: 'Custom Action: Stop holding (Command mode)' }

    event_rotate_right:                   { default: [], selector: { action: {} }, name: 'Custom Action: Rotate Right (Event mode)' }
    event_rotate_left:                    { default: [], selector: { action: {} }, name: 'Custom Action: Rotate Left (Event mode)' }
    event_single:                         { default: [], selector: { action: {} }, name: 'Custom Action: Single Press (Event mode)' }
    event_double:                         { default: [], selector: { action: {} }, name: 'Custom Action: Double Press (Event mode)' }
    event_hold:                           { default: [], selector: { action: {} }, name: 'Custom Action: Hold (Event mode)' }

    mode_change:                          { default: [], selector: { action: {} }, name: 'Custom Action: Mode changed (Triple click)' }

trigger:
  - platform: mqtt
    topic: !input mqtt_topic

# queue subsequent runs so they register
mode: queued
max: 25

# increase log size since rotating can generate a lot of events
trace: { stored_traces: 30 }

variables:
  step_size: !input step_size
  light: !input light
  light_min_kelvin: "{{ light and state_attr(light, 'min_color_temp_kelvin') }}"
  light_max_hue: 357 # threshold just below 359 to account for fractions

action:
  - variables:
      action: "{{ trigger.payload_json.action }}"
      action_step_size: "{{ trigger.payload_json.action_step_size or 13 }}"
      adjustment_pct: "{{ action_step_size / 13 * step_size }}"
      # note: action_transition_time 0.1 to 0.3 depending on how fast knob turned

      current_light_mode: "{{ light and state_attr(light, 'color_mode') }}"
      current_light_kelvin: "{{ light and state_attr(light, 'color_temp_kelvin') or 3000 }}"
      current_light_hue: "{{ light and state_attr(light, 'hs_color')[0] or 200 }}"
      current_light_sat: "{{ light and state_attr(light, 'hs_color')[1] or 100 }}"

  - parallel:
      - choose:
          - conditions: "{{ light and (action == 'toggle' or action == 'single') }}"
            sequence:
              - service: light.toggle
                entity_id: !input light

          - conditions: "{{ light and (action == 'brightness_step_down' or action == 'rotate_left') }}"
            sequence:
              - service: light.turn_on
                entity_id: !input light
                data: { brightness_step_pct: "{{ -1 * adjustment_pct }}" }
          - conditions: "{{ light and (action == 'brightness_step_up' or action == 'rotate_right') }}"
            sequence:
              - service: light.turn_on
                entity_id: !input light
                data: { brightness_step_pct: "{{ adjustment_pct }}" }

          - conditions: "{{ light and action == 'hue_move' }}"
            sequence:
              - if: { conditions: "{{ current_light_mode == 'color_temp' }}" }
                then:
                  - alias: Switch to hue (color) mode
                    service: light.turn_on
                    entity_id: !input light
                    data: { hs_color: [ "{{ current_light_hue }}", "{{ current_light_sat }}" ]  }
                else:
                  - alias: Switch to color temp mode
                    service: light.turn_on
                    entity_id: !input light
                    data: { kelvin: "{{ current_light_kelvin }}" }

          - conditions: "{{ light and action == 'color_temperature_step_down' }}"
            sequence:
              - if: { conditions: "{{ current_light_mode == 'color_temp' }}" }
                then:
                  - alias: Color temp down
                    service: light.turn_on
                    entity_id: !input light
                    data: { kelvin: "{{ current_light_kelvin + (-10 * adjustment_pct) }}" }
                else:
                  - alias: Hue down
                    service: light.turn_on
                    entity_id: !input light
                    data: { hs_color: [ "{{ (current_light_hue - adjustment_pct) % 360 }}", "{{ current_light_sat }}" ] }

          - conditions: "{{ light and action == 'color_temperature_step_up' }}"
            sequence:
              - if: { conditions: "{{ current_light_mode == 'color_temp' }}" }
                then:
                  - alias: Color temp up
                    service: light.turn_on
                    entity_id: !input light
                    data: { kelvin: "{{ current_light_kelvin + (10 * adjustment_pct) }}" }
                else:
                  - alias: Hue up
                    service: light.turn_on
                    entity_id: !input light
                    data: { hs_color: [ "{{ (current_light_hue + adjustment_pct) % 360 }}", "{{ current_light_sat }}"  ]  }

      - choose:
          # mode change
          - { conditions: "{{ action == null }}",                           sequence: !input mode_change }

          # command mode
          - { conditions: "{{ action == 'brightness_step_down' }}",         sequence: !input command_brightness_step_down }
          - { conditions: "{{ action == 'brightness_step_up' }}",           sequence: !input command_brightness_step_up }
          - { conditions: "{{ action == 'color_temperature_step_down' }}",  sequence: !input command_color_temperature_step_down }
          - { conditions: "{{ action == 'color_temperature_step_up' }}",    sequence: !input command_color_temperature_step_up }
          - { conditions: "{{ action == 'toggle' }}",                       sequence: !input command_toggle }
          - { conditions: "{{ action == 'hue_move' }}",                     sequence: !input command_hue_move }
          - { conditions: "{{ action == 'hue_stop' }}",                     sequence: !input command_hue_stop }

          # event mode
          - { conditions: "{{ action == 'rotate_right' }}",                 sequence: !input event_rotate_right }
          - { conditions: "{{ action == 'rotate_left' }}",                  sequence: !input event_rotate_left }
          - { conditions: "{{ action == 'single' }}",                       sequence: !input event_single }
          - { conditions: "{{ action == 'double' }}",                       sequence: !input event_double }
          - { conditions: "{{ action == 'hold' }}",                         sequence: !input event_hold }

